{"version":3,"sources":["select/SeparatePopup.js"],"names":["cx","SelectSeparatePopup","props","onWindowResize","handler","bind","clearTimeout","windowResizeTimer","setTimeout","id","Date","now","state","styles","top","left","height","opacity","width","onClick","componentDidMount","on","document","body","componentWillReceiveProps","nextProps","open","window","setState","getStyle","componentWillUnmount","off","target","main","targetPosition","getPosition","style","overflow","popupPosition","scrollTop","getScrollTop","scrollLeft","getScrollLeft","clientWidth","getClientWidth","clientHeight","getClientHeight","rTop","rLeft","Math","max","e","onHide","contains","render","children","className","build","contentClassName","part","stiffness","damping","visibility","displayName","propTypes","object","isRequired","func"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAA;;;;;AAWA,QAAMA,KAAK,uBAAO,eAAP,CAAX;;QAEqBC,mB;;;AAEjB,qCAAYC,KAAZ,EAAmB;AAAA;;AAAA,qEAEf,sBAAMA,KAAN,CAFe;;AAIf;AACA,kBAAKC,cAAL,GAAuB,YAAM;;AAEzB,oBAAIC,UAAU,MAAKD,cAAL,CAAoBE,IAApB,OAAd;;AAEA,uBAAO,YAAM;AACTC,iCAAa,MAAKC,iBAAlB;AACA,0BAAKA,iBAAL,GAAyBC,WAAWJ,OAAX,EAAoB,GAApB,CAAzB;AACH,iBAHD;AAKH,aATqB,EAAtB;;AAWA,kBAAKK,EAAL,GAAUC,KAAKC,GAAL,EAAV;;AAEA,kBAAKC,KAAL,GAAa;AACTC,wBAAQ;AACJC,yBAAK,CADD;AAEJC,0BAAM,CAAC,IAFH;AAGJC,4BAAQ,CAHJ;AAIJC,6BAAS,CAJL;AAKJC,2BAAO;AALH;AADC,aAAb;;AAUA,kBAAKC,OAAL,GAAe,MAAKA,OAAL,CAAad,IAAb,OAAf;AACA,kBAAKF,cAAL,GAAsB,MAAKA,cAAL,CAAoBE,IAApB,OAAtB;;AA7Be;AA+BlB;;sCAEDe,iB,gCAAoB;AAChB,6BAAQC,EAAR,CAAWC,SAASC,IAApB,EAA0B,OAA1B,EAAmC,KAAKJ,OAAxC;AACH,S;;sCAEDK,yB,sCAA0BC,S,EAAW;;AAEjC,gBAAIC,OAAOD,UAAUC,IAArB;;AAEA,6BAAQA,OAAO,IAAP,GAAc,KAAtB,EAA6BC,MAA7B,EAAqC,QAArC,EAA+C,KAAKxB,cAApD;;AAEA,iBAAKyB,QAAL,6BACO,KAAKhB,KADZ;AAEIC,wBAAQ,KAAKgB,QAAL,CAAcH,IAAd;AAFZ;AAKH,S;;sCAEDI,oB,mCAAuB;AACnB,6BAAQC,GAAR,CAAYJ,MAAZ,EAAoB,QAApB,EAA8B,KAAKxB,cAAnC;AACA,6BAAQ4B,GAAR,CAAYJ,MAAZ,EAAoB,OAApB,EAA6B,KAAKR,OAAlC;AACH,S;;sCAEDU,Q,qBAASH,I,EAAM;;AAEX,gBAAI,CAACA,IAAL,EAAW;AACP,mDACO,KAAKd,KAAL,CAAWC,MADlB;AAEIG,4BAAQ,CAFZ;AAGIC,6BAAS;AAHb;AAKH;;AAED,gBAAIe,SAAS,KAAK9B,KAAL,CAAW8B,MAAxB;AACA,gBAAIC,OAAO,KAAKA,IAAhB;;AAEA,gBAAIC,iBAAiB,iBAAQC,WAAR,CAAoBH,MAApB,CAArB;;AAbW,8BAqBPC,KAAKG,KArBE;AAAA,gBAgBPtB,GAhBO,eAgBPA,GAhBO;AAAA,gBAiBPC,IAjBO,eAiBPA,IAjBO;AAAA,gBAkBPG,KAlBO,eAkBPA,KAlBO;AAAA,gBAmBPF,MAnBO,eAmBPA,MAnBO;AAAA,gBAoBPqB,QApBO,eAoBPA,QApBO;;;AAuBX;AACAJ,iBAAKG,KAAL,CAAWtB,GAAX,GAAiB,GAAjB;AACAmB,iBAAKG,KAAL,CAAWrB,IAAX,GAAkB,SAAlB;AACAkB,iBAAKG,KAAL,CAAWC,QAAX,GAAsB,SAAtB;AACAJ,iBAAKG,KAAL,CAAWpB,MAAX,GAAoB,MAApB;AACAiB,iBAAKG,KAAL,CAAWlB,KAAX,GAAmB,MAAnB;;AAEA,gBAAIoB,gBAAgB,iBAAQH,WAAR,CAAoBF,IAApB,CAApB;;AAEAA,iBAAKG,KAAL,CAAWtB,GAAX,GAAiBA,GAAjB;AACAmB,iBAAKG,KAAL,CAAWrB,IAAX,GAAkBA,IAAlB;AACAkB,iBAAKG,KAAL,CAAWC,QAAX,GAAsBA,QAAtB;AACAJ,iBAAKG,KAAL,CAAWpB,MAAX,GAAoBA,MAApB;AACAiB,iBAAKG,KAAL,CAAWlB,KAAX,GAAmBA,KAAnB;;AAEA,gBAAIqB,YAAY,iBAAQC,YAAR,EAAhB;AACA,gBAAIC,aAAa,iBAAQC,aAAR,EAAjB;AACA,gBAAIC,cAAc,iBAAQC,cAAR,EAAlB;AACA,gBAAIC,eAAe,iBAAQC,eAAR,EAAnB;;AAEA,gBAAIC,aAAJ;AACA,gBAAIC,cAAJ;;AAEA;AACA;AACA,gBAAId,eAAepB,GAAf,GAAqBwB,cAActB,MAAnC,GAA4CuB,YAAYM,YAA5D,EAA0E;AACtEE,uBAAOb,eAAepB,GAAtB;AACH;AACD;AAHA,iBAIK;AACDiC,2BAAOF,eAAeN,SAAf,GAA2BD,cAActB,MAAzC,GAAkD,EAAzD;AACH;;AAED;AACA;AACA,gBAAIkB,eAAenB,IAAf,GAAsBuB,cAAcpB,KAApC,GAA4CyB,cAAcF,UAA9D,EAA0E;AACtEO,wBAAQd,eAAenB,IAAvB;AACH;AACD;AAHA,iBAIK;AACDiC,4BAAQL,cAAcF,UAAd,GAA2BH,cAAcpB,KAAzC,GAAiD,EAAzD;AACH;;AAGD,mBAAO;AACHD,yBAAS,CADN;AAEHH,qBAAKiC,IAFF;AAGHhC,sBAAMiC,KAHH;AAIHhC,wBAAQsB,cAActB,MAJnB;AAKHE,uBAAO+B,KAAKC,GAAL,CAAShB,eAAehB,KAAxB,EAA+BoB,cAAcpB,KAA7C;AALJ,aAAP;AAQH,S;;sCAEDC,O,oBAAQgC,C,EAAG;;AAEP,gBAAInB,SAASmB,EAAEnB,MAAf;AACA,gBAAIC,OAAO,KAAKA,IAAhB;AAHO,yBAIc,KAAK/B,KAJnB;AAAA,gBAIFkD,MAJE,UAIFA,MAJE;AAAA,gBAIM1B,IAJN,UAIMA,IAJN;;;AAMP,gBAAIA,QAAQO,SAASD,MAAjB,IAA2B,CAAC,iBAAQqB,QAAR,CAAiBpB,IAAjB,EAAuBD,MAAvB,CAAhC,EAAgE;AAC5DoB,0BAAUA,QAAV;AACH;AAEJ,S;;sCAEDjD,c,6BAAiB;AACb,iBAAKyB,QAAL,6BACO,KAAKhB,KADZ;AAEIC,wBAAQ,KAAKgB,QAAL,CAAc,IAAd;AAFZ;AAIH,S;;sCAEDyB,M,qBAAS;AAAA;;AAEL,gBAAMC,WAAW,KAAKrD,KAAL,CAAWqD,QAA5B;;AAEA,gBAAMC,YAAYxD,GAAG,KAAKE,KAAR,EAAeuD,KAAf,EAAlB;AACA,gBAAMC,mBAAmB1D,KAAK2D,IAAL,CAAU,SAAV,EAAqBF,KAArB,EAAzB;;AAEA,gBAAM5C,SAAS,KAAKD,KAAL,CAAWC,MAA1B;AAPK,gBAQEG,MARF,GAQqBH,MARrB,CAQEG,MARF;AAAA,gBAQUC,OARV,GAQqBJ,MARrB,CAQUI,OARV;;;AAUL,mBACI;AAAA;AAAA;AACI,uDACOJ,MADP;AAEIG,gCAAQ,yBAAOA,MAAP,EAAe,EAAC4C,WAAW,GAAZ,EAAiBC,SAAS,EAA1B,EAAf,CAFZ;AAGI5C,iCAAS,yBAAOA,OAAP,EAAgB,EAAC2C,WAAW,GAAZ,EAAiBC,SAAS,EAA1B,EAAhB;AAHb,sBADJ;AAMK;AAAA,2BACG;AAAA;AAAA;AACI,uCAAWL,SADf;AAEI,+DACOpB,KADP;AAEI0B,4CAAY1B,MAAMnB,OAAN,GAAgB,GAAhB,GAAsB,QAAtB,GAAiC;AAFjD,8BAFJ;AAMI,iCAAK,mBAAQ;AACT,oCAAIgB,IAAJ,EAAU;AACN,2CAAKA,IAAL,GAAYA,IAAZ;AACH;AACJ,6BAVL;AAWI;AAAA;AAAA,8BAAK,WAAWyB,gBAAhB;AACKH;AADL;AAXJ,qBADH;AAAA;AANL,aADJ;AA2BH,S;;;;;yBA9LgBtD,mB;;;AAkMrBA,wBAAoB8D,WAApB,GAAkC,qBAAlC;;AAEA9D,wBAAoB+D,SAApB,GAAgC;AAC5BhC,gBAAQ,iBAAUiC,MAAV,CAAiBC,UADG;AAE5Bd,gBAAQ,iBAAUe,IAAV,CAAeD;AAFK,KAAhC","file":"SeparatePopup.js","sourcesContent":["/**\n * @file melon/select/SeparatePopup\n * @author leon(ludafa@outlook.com)\n */\n\nimport React, {Component, PropTypes} from 'react';\nimport {Motion, spring} from 'react-motion';\nimport domUtil from '../common/util/dom';\n\nimport {create} from 'melon-core/classname/cxBuilder';\n\nconst cx = create('SeparatePopup');\n\nexport default class SelectSeparatePopup extends Component {\n\n    constructor(props) {\n\n        super(props);\n\n        // 做一个可以随时释放的 debounce 啦\n        this.onWindowResize = (() => {\n\n            let handler = this.onWindowResize.bind(this);\n\n            return () => {\n                clearTimeout(this.windowResizeTimer);\n                this.windowResizeTimer = setTimeout(handler, 500);\n            };\n\n        })();\n\n        this.id = Date.now();\n\n        this.state = {\n            styles: {\n                top: 0,\n                left: -5000,\n                height: 0,\n                opacity: 0,\n                width: 0\n            }\n        };\n\n        this.onClick = this.onClick.bind(this);\n        this.onWindowResize = this.onWindowResize.bind(this);\n\n    }\n\n    componentDidMount() {\n        domUtil.on(document.body, 'click', this.onClick);\n    }\n\n    componentWillReceiveProps(nextProps) {\n\n        let open = nextProps.open;\n\n        domUtil[open ? 'on' : 'off'](window, 'resize', this.onWindowResize);\n\n        this.setState({\n            ...this.state,\n            styles: this.getStyle(open)\n        });\n\n    }\n\n    componentWillUnmount() {\n        domUtil.off(window, 'resize', this.onWindowResize);\n        domUtil.off(window, 'click', this.onClick);\n    }\n\n    getStyle(open) {\n\n        if (!open) {\n            return {\n                ...this.state.styles,\n                height: 0,\n                opacity: 0\n            };\n        }\n\n        let target = this.props.target;\n        let main = this.main;\n\n        let targetPosition = domUtil.getPosition(target);\n\n        let {\n            top,\n            left,\n            width,\n            height,\n            overflow\n        } = main.style;\n\n        // 先把这个货弄走，展开计算它的宽度和高度\n        main.style.top = '0';\n        main.style.left = '-5000px';\n        main.style.overflow = 'visible';\n        main.style.height = 'auto';\n        main.style.width = 'auto';\n\n        let popupPosition = domUtil.getPosition(main);\n\n        main.style.top = top;\n        main.style.left = left;\n        main.style.overflow = overflow;\n        main.style.height = height;\n        main.style.width = width;\n\n        let scrollTop = domUtil.getScrollTop();\n        let scrollLeft = domUtil.getScrollLeft();\n        let clientWidth = domUtil.getClientWidth();\n        let clientHeight = domUtil.getClientHeight();\n\n        let rTop;\n        let rLeft;\n\n        // 首先计算垂直位置\n        // 如垂直位置从目标的上边缘开始，如果加上浮层高度，未溢出视野，那么就取目标上边缘\n        if (targetPosition.top + popupPosition.height < scrollTop + clientHeight) {\n            rTop = targetPosition.top;\n        }\n        // 否则尽量贴在视野的底边上，如果此时浮层顶部溢出了视野，那说明视野就是太小了。。。\n        else {\n            rTop = clientHeight + scrollTop - popupPosition.height - 20;\n        }\n\n        // 然后计算水平位置\n        // 尝试以目标的左边缘开始，如果加上浮层宽宽未溢出视野，那么取目标左边缘\n        if (targetPosition.left + popupPosition.width < clientWidth + scrollLeft) {\n            rLeft = targetPosition.left;\n        }\n        // 否则尽量贴在视野的右边，如果此时浮层左侧溢出视野，那说明视野就是太小了。\n        else {\n            rLeft = clientWidth + scrollLeft - popupPosition.width - 20;\n        }\n\n\n        return {\n            opacity: 1,\n            top: rTop,\n            left: rLeft,\n            height: popupPosition.height,\n            width: Math.max(targetPosition.width, popupPosition.width)\n        };\n\n    }\n\n    onClick(e) {\n\n        let target = e.target;\n        let main = this.main;\n        let {onHide, open} = this.props;\n\n        if (open && main !== target && !domUtil.contains(main, target)) {\n            onHide && onHide();\n        }\n\n    }\n\n    onWindowResize() {\n        this.setState({\n            ...this.state,\n            styles: this.getStyle(true)\n        });\n    }\n\n    render() {\n\n        const children = this.props.children;\n\n        const className = cx(this.props).build();\n        const contentClassName = cx().part('content').build();\n\n        const styles = this.state.styles;\n        const {height, opacity} = styles;\n\n        return (\n            <Motion\n                style={{\n                    ...styles,\n                    height: spring(height, {stiffness: 120, damping: 15}),\n                    opacity: spring(opacity, {stiffness: 120, damping: 15})\n                }}>\n                {style =>\n                    <div\n                        className={className}\n                        style={{\n                            ...style,\n                            visibility: style.opacity < 0.1 ? 'hidden' : 'visible'\n                        }}\n                        ref={main => {\n                            if (main) {\n                                this.main = main;\n                            }\n                        }}>\n                        <div className={contentClassName} >\n                            {children}\n                        </div>\n                    </div>\n                }\n            </Motion>\n        );\n\n    }\n\n}\n\nSelectSeparatePopup.displayName = 'SelectSeparatePopup';\n\nSelectSeparatePopup.propTypes = {\n    target: PropTypes.object.isRequired,\n    onHide: PropTypes.func.isRequired\n};\n"]}