{"version":3,"sources":["Menu.js"],"names":["cx","getChildMenuKey","index","Menu","args","onMainMenuItemClick","bind","onChildMenuItemClick","onChildMenuOpen","onChildMenuClose","onMotionEnd","setMainRef","setRef","setLayerRef","state","closing","componentWillMount","setState","getChildState","props","componentWillReceiveProps","nextProps","children","open","openChildMenu","componentDidUpdate","main","layer","anchorAlignment","layerAlignment","points","overflow","adjustX","adjustY","e","onOpen","onClose","handler","childIndex","closeAncestors","name","ref","cascading","toArray","filter","child","type","indent","some","icon","childMenuIndex","reduce","menuState","Object","keys","nextChildMenuIndex","childKey","renderChildren","menuIndex","map","extraProps","level","renderLayer","begin","end","content","opacity","scale","stiffness","damping","getPartClassName","transform","render","label","style","className","addVariants","build","ARCHOR_DIRECTIONS","propTypes","width","number","oneOfType","string","element","disabled","bool","isRequired","oneOf","defaultProps","MenuItem"],"mappings":"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","file":"Menu.js","sourcesContent":["/**\n * @file Menu\n * @author leon <ludafa@outlook.com>\n */\n\nimport React, {Component, Children, cloneElement} from 'react';\nimport PropTypes from 'prop-types';\nimport MenuItem from './menu/MenuItem';\nimport Divider from './Divider';\nimport {create} from 'melon-core/classname/cxBuilder';\nimport Icon from './Icon';\nimport {Motion, spring} from 'react-motion';\nimport align from 'dom-align';\n\nconst cx = create('Menu');\n\nfunction getChildMenuKey(index) {\n    return `child-menu-${index}`;\n}\n\nexport default class Menu extends Component {\n\n    constructor(...args) {\n        super(...args);\n        this.onMainMenuItemClick = this.onMainMenuItemClick.bind(this);\n        this.onChildMenuItemClick = this.onChildMenuItemClick.bind(this);\n        this.onChildMenuOpen = this.onChildMenuOpen.bind(this);\n        this.onChildMenuClose = this.onChildMenuClose.bind(this);\n        this.onMotionEnd = this.onMotionEnd.bind(this);\n        this.setMainRef = this.setRef.bind(this, 'main');\n        this.setLayerRef = this.setRef.bind(this, 'layer');\n        this.state = {\n            closing: false\n        };\n    }\n\n    componentWillMount() {\n        this.setState(\n            this.getChildState(this.props)\n        );\n    }\n\n    componentWillReceiveProps(nextProps) {\n\n        let {children, open} = this.props;\n\n        // 如果属性 children 发生变化，那么更新子结点相关的状态\n        if (nextProps.children !== children) {\n            this.setState(this.getChildState(nextProps));\n        }\n\n        if (nextProps.open !== open) {\n\n            // 激活关闭动画\n            this.setState({\n                closing: !nextProps.open\n            });\n\n            // 关闭所有的子菜单\n            this.openChildMenu(null);\n\n        }\n\n    }\n\n    componentDidUpdate() {\n\n        let {main, layer} = this;\n\n        if (main && layer) {\n\n            let {anchorAlignment, layerAlignment} = this.props;\n\n            align(\n                layer,\n                main,\n                {\n                    points: [layerAlignment, anchorAlignment],\n                    overflow: {\n                        adjustX: true,\n                        adjustY: true\n                    }\n                }\n            );\n\n        }\n\n    }\n\n    onMainMenuItemClick(e) {\n        let {onOpen, onClose, open, index} = this.props;\n        let handler = open ? onClose : onOpen;\n        handler && handler(index);\n    }\n\n    onChildMenuItemClick() {\n        let {onClose, index} = this.props;\n        onClose && onClose(index, true);\n    }\n\n    onChildMenuOpen(childIndex) {\n        this.openChildMenu(childIndex);\n    }\n\n    onChildMenuClose(childIndex, closeAncestors = false) {\n\n        this.openChildMenu(null);\n\n        if (closeAncestors) {\n            let {onClose, index} = this.props;\n            onClose && onClose(index, closeAncestors);\n        }\n\n    }\n\n    onMotionEnd() {\n        this.setState({closing: false});\n    }\n\n    setRef(name, ref) {\n        this[name] = ref;\n    }\n\n    getChildState({children, cascading}) {\n\n        children = Children.toArray(children) || [];\n\n        // 过滤掉没用的子结点\n        children = children.filter(child => (\n            child.type === Menu\n            || child.type === MenuItem\n            || child.type === Divider\n        ));\n\n        // 如果有任意一个子组件有 icon，那么所有的子组件都是 indent 的\n        let indent = children.some(child => (\n            child.type === MenuItem && !!child.props.icon\n        ));\n\n        // 如果有任意一个子组件是 menu，那么此 menu 是级联 menu\n        if (!cascading) {\n            cascading = children.some(child => (child.type === Menu));\n        }\n\n        // 生成子结点的索引\n        let childMenuIndex = children\n            .filter(child => child.type === Menu)\n            .reduce(\n                (menuState, child, index) => {\n                    menuState[getChildMenuKey(index)] = false;\n                    return menuState;\n                },\n                {}\n            );\n\n        return {\n            indent,\n            cascading,\n            children,\n            childMenuIndex\n        };\n\n    }\n\n    /**\n     * 打开指定的子 menu\n     *\n     * 如果不指定 childIndex，那会把所有的子菜单都关上\n     *\n     * @param  {number?} childIndex 子菜单序号\n     */\n    openChildMenu(childIndex) {\n\n        let childMenuIndex = Object\n            .keys(this.state.childMenuIndex)\n            .reduce(\n                (nextChildMenuIndex, childKey) => {\n                    nextChildMenuIndex[childKey] = childIndex != null\n                        && getChildMenuKey(childIndex) === childKey;\n                    return nextChildMenuIndex;\n                },\n                {}\n            );\n\n        this.setState({\n            childMenuIndex\n        });\n\n    }\n\n    renderChildren() {\n\n        let {indent, cascading, children, childMenuIndex} = this.state;\n\n        let menuIndex = 0;\n\n        // 给子组件附加属性\n        return children.map((child, index) => {\n\n            let extraProps = {\n                level: this.props.level + (child.type === Menu ? 1 : 0),\n                indent,\n                cascading\n            };\n\n            if (child.type === MenuItem) {\n                extraProps.onClose = this.onChildMenuItemClick;\n            }\n            else if (child.type === Menu) {\n                extraProps.onOpen = this.onChildMenuOpen;\n                extraProps.onClose = this.onChildMenuClose;\n                extraProps.open = childMenuIndex[getChildMenuKey(menuIndex)];\n                extraProps.index = menuIndex++;\n            }\n\n            return cloneElement(child, extraProps);\n\n        });\n\n    }\n\n    renderLayer() {\n\n        let open = this.props.open;\n        let closing = this.state.closing;\n\n        let begin = open && !closing ? 0 : 1;\n        let end = open && !closing ? 1 : 0;\n\n        let content = this.renderChildren();\n\n        return (\n            <Motion\n                defaultStyle={{\n                    opacity: begin,\n                    scale: begin\n                }}\n                style={{\n                    opacity: spring(end),\n                    scale: spring(end, {stiffness: 260, damping: 20})\n                }}\n                onRest={this.onMotionEnd}>\n                {({scale, opacity}) => (\n                    <div\n                        ref={this.setLayerRef}\n                        className={cx.getPartClassName('children-popover')}\n                        style={{\n                            opacity: opacity,\n                            transform: `scale(${scale}, ${scale})`\n                        }}>\n                        {content}\n                    </div>\n                )}\n            </Motion>\n        );\n\n    }\n\n    render() {\n\n        let {\n            level,\n            label,\n            style,\n            icon,\n            open\n        } = this.props;\n\n        let closing = this.state.closing;\n\n        let className = cx(this.props)\n            .addVariants(`level-${level}`);\n\n        if (level === 0) {\n            return (\n                <div\n                    className={className.build()}\n                    style={style}>\n                    {this.renderChildren()}\n                </div>\n            );\n        }\n\n        // 如果 level 不是 0 级，那么把这货做成一个 MenuItem + Popover 的形式\n        return (\n            <div\n                className={className.addVariants('item').build()}\n                ref={this.setMainRef}>\n                <MenuItem\n                    type=\"command\"\n                    icon={icon}\n                    label={label}\n                    indent={this.props.indent}\n                    cascading={true}\n                    onClick={this.onMainMenuItemClick}>\n                </MenuItem>\n                <Icon\n                    icon=\"arrow-drop-down\"\n                    className={cx.getPartClassName('cascading-icon')} />\n                {open || closing ? this.renderLayer() : null}\n            </div>\n        );\n\n\n    }\n\n}\n\nconst ARCHOR_DIRECTIONS = [\n    'tl', 'tc', 'tr',\n    'cl', 'cc', 'cr',\n    'bl', 'bc', 'br'\n];\n\nMenu.propTypes = {\n    width: PropTypes.number,\n    icon: PropTypes.oneOfType([PropTypes.string, PropTypes.element]),\n    label: PropTypes.string,\n    disabled: PropTypes.bool,\n    open: PropTypes.bool.isRequired,\n    level: PropTypes.number,\n    layerAlignment: PropTypes.oneOf(ARCHOR_DIRECTIONS),\n    anchorAlignment: PropTypes.oneOf(ARCHOR_DIRECTIONS)\n};\n\nMenu.defaultProps = {\n    level: 0,\n    width: 300,\n    open: false,\n    layerAlignment: 'tl',\n    anchorAlignment: 'tr'\n};\n\nexport {\n    MenuItem\n};\n"]}